{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Cart | Pawsome Care</title>

    <link rel="stylesheet" href="{% static 'css/customer/cart.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar">
    <div class="logo-wrapper">
        <img src="{% static 'images/pawsomecare-logo.png' %}" class="logo-img">
        <h2 class="logo">Pawsome<span>Care</span></h2>
    </div>

    <ul class="nav-links">
        <li><a href="{% url 'customer_home' %}">Home</a></li>
        <li><a href="{% url 'my_pets' %}">My Pets</a></li>
        <li><a href="{% url 'service_bookings' %}">Bookings</a></li>
        <li><a href="{% url 'shop' %}">Shop</a></li>
        <li><a href="#" class="active">Cart</a></li>
    </ul>

    <a href="{% url 'goback' %}" class="btn-secondary">Logout</a>
</nav>

<!-- CART PAGE -->
<section class="cart-page">
    <h1>üõí My Cart</h1>

    <div class="cart-layout">

        <!-- CART ITEMS -->
        <div class="cart-items">

            {% if cart_items %}
                {% for item in cart_items %}
                <div class="cart-item">

                    <img src="{{ item.product.product_image.url }}" alt="{{ item.product.product_name }}">

                    <div class="item-info">
                        <h3>{{ item.product.product_name }}</h3>
                        <p>{{ item.product.product_category }}</p>
                    </div>

                    <div class="qty-control">
                        <a href="{% url 'decrease_qty' item.id %}" class="qty-btn">‚àí</a>
                        <span>{{ item.quantity }}</span>
                        <a href="{% url 'increase_qty' item.id %}" class="qty-btn">+</a>
                    </div>

                    <div class="item-price">
                        ‚Çπ{{ item.product.product_price }}
                    </div>

                    <a href="{% url 'remove_from_cart' item.id %}" class="remove-btn">‚úï</a>
                </div>
                {% endfor %}
            {% else %}
                <p class="empty-cart">Your cart is empty üêæ</p>
            {% endif %}

        </div>

        <!-- SUMMARY -->
        <div class="cart-summary">
            <h2>Order Summary</h2>

            <div class="summary-row">
                <span>Subtotal</span>
                <span>‚Çπ{{ subtotal }}</span>
            </div>

            <div class="summary-row">
                <span>Delivery</span>
                <span>‚Çπ99</span>
            </div>

            <div class="summary-row total">
                <span>Total</span>
                <span>‚Çπ{{ total }}</span>
            </div>

            <button class="checkout-btn">Proceed to Checkout</button>
        </div>

    </div>
</section>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const checkoutBtn = document.querySelector(".checkout-btn");

    if (!checkoutBtn) {
        console.error("Checkout button not found");
        return;
    }

    checkoutBtn.addEventListener("click", function () {

        console.log("Checkout clicked");

        fetch("{% url 'create_cart_order' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}"
            }
        })
        .then(response => response.json())
        .then(data => {

            console.log("Order data:", data);

            const options = {
                key: data.key,
                amount: data.amount,
                currency: "INR",
                name: "Pawsome Care",
                description: "Cart Payment",
                order_id: data.order_id,

                handler: function (response) {

                    fetch("{% url 'verify_cart_payment' %}", {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}",
                            "Content-Type": "application/x-www-form-urlencoded"
                        },
                        body:
                            `razorpay_order_id=${response.razorpay_order_id}` +
                            `&razorpay_payment_id=${response.razorpay_payment_id}` +
                            `&razorpay_signature=${response.razorpay_signature}`
                    })
                    .then(res => res.json())
                    .then(result => {
                        if (result.status === "success") {
                            alert("Payment Successful üéâ");
                            window.location.href = "{% url 'shop' %}";
                        } else {
                            alert("Payment Failed ‚ùå");
                        }
                    });
                }
            };

            new Razorpay(options).open();
        })
        .catch(err => console.error("Payment error:", err));
    });

});
</script>



</body>
</html>
