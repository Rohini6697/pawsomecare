{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Book {{ service|title }} | {{ provider.full_name }}</title>

    <link rel="stylesheet" href="{% static 'css/customer/slot_booking.css' %}">
</head>
<body>
<button type="button" class="back-btn" onclick="window.history.back()">
    ‚Üê Go Back
</button>

<div class="page">

    <!-- PROVIDER HEADER -->
    <div class="provider-header">
        <h2>{{ provider.full_name }}</h2>
        <span class="badge">{{ provider.get_provider_type_display }}</span>
        <p class="city">{{ provider.city }}</p>
    </div>

    <!-- SERVICE SUMMARY -->
    <div class="service-card">
        <h3>Selected Service</h3>
        <div class="service-row">
            <span class="service-name">{{ service|title }}</span>
            <span class="price">‚Çπ{{ price }}</span>
        </div>
    </div>

    <!-- SLOT & PAYMENT -->
    <div class="slot-card">
        <h3>Select Time Slot</h3>

        <form id="bookingForm" method="POST">
            {% csrf_token %}

            {% if slots %}
                <div class="slots-grid">
                    {% for slot in slots %}
                        <label class="slot">
                            <input type="radio" name="slot_id" value="{{ slot.id }}" required>
                            <div class="slot-info">
                                <span>üìÖ {{ slot.date }}</span>
                                <span>‚è∞ {{ slot.time }}</span>
                            </div>
                        </label>
                    {% endfor %}
                </div>
            {% else %}
                <p class="no-slots">No slots available.</p>
            {% endif %}

            <!-- Hidden fields -->
            <input type="hidden" name="service" value="{{ service }}">
            <input type="hidden" name="amount" value="{{ price }}">

            <div class="button-group">

                <!-- CASH ON SERVICE -->
                <button
                    type="submit"
                    formaction="{% url 'cash_on_service_booking' provider.id %}"
                    class="book-btn cos-btn"
                >
                    Cash on Service
                </button>

                <!-- ONLINE PAYMENT -->
                <button
                    type="button"
                    class="pay-btn"
                    id="payBtn"
                    disabled
                >
                    Proceed to Payment
                </button>

            </div>
        </form>
    </div>

</div>

<!-- Razorpay -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
// ‚úÖ Enable buttons when slot selected
document.querySelectorAll("input[name='slot_id']").forEach(input => {
    input.addEventListener("change", () => {
        document.getElementById("payBtn").disabled = false;
    });
});

// ‚úÖ Handle ONLINE payment
document.getElementById("payBtn").addEventListener("click", function () {

    const form = document.getElementById("bookingForm");
    const formData = new FormData(form);

    this.disabled = true;
    this.innerText = "Processing...";

    fetch("{% url 'create_service_order' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: formData
    })
    .then(res => res.json())
    .then(data => {

        const options = {
            key: data.key,
            amount: data.amount,
            currency: "INR",
            name: "Pawsome Care",
            description: "{{ service|title }}",
            order_id: data.order_id,

            handler: function (response) {

                fetch("{% url 'verify_service_payment' %}", {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body:
                        `razorpay_order_id=${response.razorpay_order_id}` +
                        `&razorpay_payment_id=${response.razorpay_payment_id}` +
                        `&razorpay_signature=${response.razorpay_signature}` +
                        `&slot_id=${formData.get("slot_id")}`
                })
                .then(() => {
                    alert("Service booked successfully!");
                    window.location.href = "{% url 'service_bookings' %}";
                });
            }
        };

        new Razorpay(options).open();
    });
});
</script>

</body>
</html>
