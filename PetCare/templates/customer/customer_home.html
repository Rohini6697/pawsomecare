{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pawsome Care | Customer Dashboard</title>

    <!-- CSS -->
    <link rel="stylesheet" href="{% static 'css/customer/customer_home.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;800&display=swap" rel="stylesheet">
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar">
    <div class="logo-wrapper">
        <img src="{% static 'images/pawsomecare-logo.png' %}" class="logo-img">
        <h2 class="logo">Pawsome<span>Care</span></h2>
    </div>

    <ul class="nav-links">
        <li><a href="{% url 'customer_home' %}">Home</a></li>
        <li><a href="{% url 'my_pets' %}">My Pets</a></li>
        <li><a href="{% url 'service_bookings' %}">Bookings</a></li>
        <li><a href="{% url 'shop' %}">Shop</a></li>
        <li><a href="{% url 'cart' %}">Cart</a></li>
    </ul>

    <a href="{% url 'goback' %}" class="btn-secondary">Logout</a>
</nav>

<!-- VOICE HINT -->
<div class="voice-hint" id="voiceHint">
    Tap ğŸ¤ and speak (example: â€œBook grooming for Brunoâ€)
</div>

<!-- VOICE BUTTON -->
<button class="voice-btn" id="voiceBtn">ğŸ¤ Speak</button>

<!-- VOICE BOX -->
<div class="voice-box" id="voiceBox">
    <h4>ğŸ¤– Pawla says</h4>
    <p id="assistantText"></p>
</div>

<!-- HERO -->
<section class="hero">
    <div class="hero-content">
        <h1>
            Everything Your Pet Needs<br>
            <span class="highlight">One Trusted Platform</span>
        </h1>
        <p>Book services and shop using voice or click.</p>

        <!-- <div class="hero-actions">
            <button class="btn-primary">Book a Service</button>
            <button class="btn-outline">Add a Pet</button>
        </div> -->
    </div>

    <div class="hero-image">
        <img src="https://t3.ftcdn.net/jpg/04/18/06/84/360_F_418068474_VIWD3loz21dusicbe43VnAsAc9uZudyF.jpg">
    </div>
</section>

<!-- DASHBOARD -->
<section class="dashboard-actions">
    <div class="action-card">
        <h3>ğŸ¾ My Pets</h3>
        <p>Manage registered pets.</p>
    </div>

    <div class="action-card">
        <h3>ğŸ“… Services</h3>
        <p>Grooming, walking, vet visits.</p>
    </div>

    <div class="action-card">
        <h3>ğŸ›’ Pet Store</h3>
        <p>Food, toys & accessories.</p>
    </div>

    <div class="action-card">
        <h3>ğŸ“Š Reports</h3>
        <p>Daily health & activity.</p>
    </div>
</section>

<footer>
    <p>Â© 2025 Pawsome Care. All Rights Reserved.</p>
</footer>

<!-- ================= VOICE ASSISTANT JS ================= -->
<script>
const voiceBtn = document.getElementById("voiceBtn");
const voiceBox = document.getElementById("voiceBox");
const assistantText = document.getElementById("assistantText");
const voiceHint = document.getElementById("voiceHint");

let recognition;
let listening = false;
let isSpeaking = false;

window.onload = () => {
    voiceHint.style.display = "block";
    setTimeout(() => voiceHint.style.display = "none", 4000);
};

voiceBtn.addEventListener("click", () => {

    if (!("webkitSpeechRecognition" in window)) {
        alert("Please use Google Chrome for voice support.");
        return;
    }

    if (listening) {
        stopListening();
        return;
    }

    startAssistant();
});

function startAssistant() {

    recognition = new webkitSpeechRecognition();
    recognition.lang = "en-US";
    recognition.continuous = true;      // ğŸ”¥ keeps listening
    recognition.interimResults = false;

    recognition.onresult = handleResult;

    recognition.onerror = (event) => {
        console.log("Speech recognition error:", event.error);
    };

    recognition.onend = () => {
        // ğŸ”¥ Restart automatically if still in listening mode
        if (listening && !isSpeaking) {
            recognition.start();
        }
    };

    listening = true;
    voiceBtn.classList.add("listening");
    voiceBtn.innerText = "ğŸ¤ Listening...";

    const welcomeText = 
        "Hi, I am Pawla. You can book pet services or buy products using your voice.";

    speak(welcomeText, () => {
        recognition.start();
    });

    voiceBox.style.display = "block";
}

function handleResult(event) {

    const command = event.results[event.results.length - 1][0].transcript;
    console.log("User said:", command);

    assistantText.innerText = `You said: "${command}"`;

    recognition.stop();   // ğŸ”¥ pause while processing

    fetch("/ai/intent/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({ command: command })
    })
    .then(res => res.json())
    .then(data => {

        console.log("Backend response:", data);

        speak(data.reply, () => {
            if (listening) {
                recognition.start();   // ğŸ”¥ resume after speaking
            }
        });

    })
    .catch(err => {
        console.error(err);
        speak("Sorry, something went wrong.", () => {
            recognition.start();
        });
    });
}

function speak(text, callback) {

    isSpeaking = true;
    assistantText.innerText = text;

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.rate = 1.05;
    utterance.pitch = 1.1;

    utterance.onend = () => {
        isSpeaking = false;
        if (callback) callback();
    };

    speechSynthesis.speak(utterance);
}

function stopListening() {
    listening = false;
    recognition.stop();
    speechSynthesis.cancel();
    voiceBtn.classList.remove("listening");
    voiceBtn.innerText = "ğŸ¤ Speak";
}

function getCSRFToken() {
    return document.cookie
        .split("; ")
        .find(row => row.startsWith("csrftoken="))
        ?.split("=")[1];
}
</script>




</body>
</html>
